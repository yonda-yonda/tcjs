<!DOCTYPE HTML>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="https://github.githubassets.com/favicon.ico">
    <title>tcjs sample2</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.6.1/css/ol.css" type="text/css">
    <style>
      .map {
        height: 400px;
        width: 100%;
      }
    </style>

    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.6.1/build/ol.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../tcjs.min.js"></script>
</head>

<body>
    <div id="default" class="map"></div>
    <hr>
    <div id="score_graph"></div>
    <hr>
    <div id="result" class="map"></div>
    <script type="text/javascript">
      const typhoon = [{"name":"VONGFONG","coordinates":[[134.0,6.8],[133.4,6.4],[132.9,6.3],[132.7,6.5],[132.5,6.7],[132.2,7.0],[132.0,7.2],[131.4,7.6],[130.9,7.9],[130.3,8.2],[129.7,8.3],[129.2,8.3],[129.0,8.7],[129.1,9.1],[129.2,9.6],[129.4,10.2],[129.5,10.7],[129.5,11.3],[129.2,11.6],[128.9,11.8],[128.4,12.0],[127.8,12.2],[127.0,12.2],[126.2,12.1],[125.3,12.2],[124.4,12.3],[123.6,12.7],[122.7,13.3],[121.9,14.0],[121.3,14.9],[120.6,16.2],[120.0,17.3],[119.6,18.1],[119.5,18.9],[119.5,19.7],[120.0,20.6],[121.1,21.3],[122.1,21.6],[123.1,22.0],[124.3,22.6],[127.0,24.4]]},{"name":"NURI","coordinates":[[126.4,11.3],[125.9,12.1],[125.4,12.9],[124.7,13.7],[123.9,14.3],[122.9,14.7],[121.8,15.1],[120.5,15.8],[119.4,16.1],[118.3,16.4],[117.6,16.8],[116.7,17.5],[115.6,18.4],[115.0,19.4],[114.0,20.1],[113.0,20.8],[112.1,21.6],[111.0,22.6]]},{"name":"SINLAKU","coordinates":[[114.0,16.6],[113.1,17.0],[111.8,17.5],[111.1,17.7],[110.7,17.8],[108.6,18.5],[107.6,18.9],[106.9,19.0],[106.5,19.2],[106.2,19.4],[104.7,19.2],[103.4,19.2],[102.2,20.2]]},{"name":"HAGUPIT","coordinates":[[131.2,15.2],[130.8,16.2],[130.2,17.2],[129.7,17.7],[129.4,18.9],[128.8,20.2],[127.7,20.8],[127.1,21.3],[126.0,22.0],[125.1,22.5],[124.4,23.0],[124.4,23.3],[124.2,23.6],[124.0,23.9],[123.9,24.3],[123.7,24.5],[123.5,25.0],[122.8,25.3],[122.6,26.2],[121.8,26.8],[121.2,27.7],[120.7,28.6],[120.4,29.7],[120.2,30.7],[120.6,32.4],[120.8,33.9],[121.3,35.0],[122.7,36.6],[125.4,38.1],[128.0,39.0],[132.1,41.0],[134.9,42.0],[136.7,43.0],[139.9,44.2],[143.0,45.5],[145.9,47.2],[147.8,47.8],[150.6,48.5],[154.0,49.3],[155.6,51.0],[158.2,51.0],[160.7,50.8],[162.4,50.9],[164.5,50.8],[167.0,50.7],[169.3,50.8],[171.0,50.8],[172.6,51.0],[174.2,51.3],[175.7,51.6],[177.0,52.0],[178.2,52.2],[179.3,52.4],[179.8,52.4],[180.7,52.3]]},{"name":"JANGMI","coordinates":[[127.5,14.2],[127.3,14.7],[127.2,15.2],[127.0,15.7],[127.0,16.3],[126.9,17.0],[126.6,18.1],[126.4,19.4],[126.4,20.8],[126.4,23.0],[126.2,25.3],[126.3,27.8],[126.8,29.5],[127.3,30.8],[127.7,32.1],[128.1,33.3],[128.5,34.6],[129.2,35.8],[130.0,37.2],[132.2,40.0],[135.9,43.0],[139.5,44.3],[143.4,45.9],[147.6,47.0],[151.5,47.8],[153.6,48.3],[155.3,48.8],[157.6,49.0],[158.7,49.4],[159.6,49.5],[160.1,49.4],[161.1,49.4],[162.1,49.3],[162.1,49.7],[162.5,49.3],[162.7,49.1]]},{"name":"MEKKHALA","coordinates":[[118.2,15.1],[118.3,16.0],[118.4,17.0],[118.5,18.1],[118.6,19.2],[118.6,20.4],[118.6,21.6],[118.3,22.9],[117.7,24.2],[117.3,25.6]]},{"name":"HIGOS","coordinates":[[123.4,17.6],[123.2,17.7],[122.9,18.5],[121.9,19.1],[120.7,19.5],[119.6,19.7],[118.4,19.8],[116.9,20.3],[115.9,20.5],[114.8,21.2],[113.8,21.6],[113.0,22.2],[112.0,22.8],[110.7,23.7],[109.4,24.0],[109.0,25.1],[108.7,26.0]]},{"name":"BAVI","coordinates":[[122.8,18.7],[123.1,20.2],[123.2,21.3],[123.1,22.1],[123.0,22.9],[122.6,23.4],[123.5,24.3],[123.7,24.7],[123.8,25.3],[123.5,25.6],[123.6,25.7],[123.8,26.0],[123.9,26.3],[124.0,26.5],[124.3,26.6],[124.6,26.7],[125.0,26.8],[125.2,27.0],[125.6,27.1],[125.9,27.2],[126.1,27.3],[126.4,27.4],[126.4,27.8],[126.4,28.2],[126.3,28.4],[126.0,28.6],[125.7,29.2],[125.5,29.8],[125.2,30.6],[124.8,31.4],[124.5,32.4],[124.3,33.6],[124.4,35.0],[125.2,37.0],[125.3,39.1],[125.0,42.0],[126.2,43.8],[127.0,45.4],[126.1,45.0],[125.6,44.7],[125.9,44.6],[125.2,45.3],[124.6,46.4],[123.6,46.8],[123.8,46.6],[124.4,46.6]]},{"name":"MAYSAK","coordinates":[[132.3,14.8],[132.1,15.4],[131.9,16.1],[131.8,16.8],[131.1,17.4],[130.2,17.2],[130.0,16.7],[129.7,16.5],[129.6,16.5],[129.3,16.7],[129.0,17.0],[129.0,17.0],[129.0,17.2],[129.0,18.4],[129.0,19.3],[128.9,20.7],[128.4,22.4],[128.2,23.3],[127.6,24.2],[127.2,24.5],[127.1,25.0],[126.8,25.5],[126.5,26.1],[126.2,26.5],[126.0,26.9],[125.9,27.3],[126.1,27.6],[126.2,28.1],[126.3,28.4],[126.5,28.9],[126.6,29.4],[126.6,30.0],[126.7,30.5],[126.9,31.2],[127.1,31.7],[127.7,32.6],[127.9,33.2],[128.3,34.1],[128.8,35.5],[129.4,37.0],[129.7,38.8],[129.1,42.3],[127.4,45.6],[125.3,47.0],[124.1,48.1],[123.4,48.9],[123.1,48.9],[123.3,49.5],[124.0,50.6],[124.8,51.6],[125.7,52.4],[126.4,52.9],[126.9,53.1],[127.3,53.0],[128.6,52.6],[130.1,52.0],[132.1,51.9]]},{"name":"HAISHEN","coordinates":[[145.5,24.9],[145.9,24.5],[146.1,23.9],[146.1,23.2],[145.9,22.6],[145.6,22.1],[144.8,21.2],[144.5,20.9],[144.0,20.5],[143.3,20.0],[142.5,19.4],[141.5,19.3],[140.4,19.7],[139.4,20.0],[138.5,20.2],[137.5,20.6],[136.6,21.0],[135.8,21.2],[135.1,21.8],[134.3,22.3],[133.5,22.7],[132.6,23.2],[132.3,23.5],[132.0,24.0],[131.6,24.2],[131.5,24.7],[131.2,25.0],[131.0,25.4],[130.9,25.8],[130.9,26.4],[130.8,27.1],[130.5,27.7],[130.3,28.5],[130.1,29.4],[129.8,30.3],[129.4,31.0],[129.2,31.9],[129.0,32.9],[129.1,34.1],[129.2,35.5],[129.3,36.9],[129.1,38.4],[128.9,39.8],[129.0,42.2],[128.3,44.0],[127.9,45.3],[127.1,45.8],[127.1,45.8],[126.9,45.6],[126.8,45.4],[125.5,44.7],[125.1,43.6],[124.4,42.9],[124.0,42.0]]},{"name":"NOUL","coordinates":[[121.8,12.8],[120.4,12.6],[119.1,12.7],[118.5,13.0],[117.7,13.1],[116.8,13.2],[115.7,13.4],[114.5,13.8],[113.8,14.6],[113.1,15.5],[111.9,15.8],[110.3,15.9],[108.3,16.3],[105.2,16.3],[104.0,16.2],[102.1,16.2]]},{"name":"DOLPHIN","coordinates":[[135.0,21.6],[134.5,22.3],[134.2,22.9],[134.0,23.6],[134.3,24.0],[134.7,24.2],[134.8,24.9],[135.0,25.3],[135.0,25.7],[135.2,26.1],[135.3,26.9],[135.8,28.1],[136.3,29.3],[137.0,30.1],[137.9,31.2],[139.3,32.1],[140.1,32.7],[140.8,32.9],[141.1,32.9],[141.3,32.9],[141.5,32.9],[141.8,32.9],[142.0,32.7],[142.4,32.7],[142.5,33.2],[142.5,33.7],[141.7,34.0],[142.1,35.5],[142.8,37.2],[144.0,38.9],[145.4,40.2],[146.0,40.9],[146.8,41.6],[147.1,42.0],[147.4,42.7],[147.9,43.5],[148.4,44.6],[149.7,45.5],[151.7,47.3],[152.9,48.8],[154.1,49.5],[157.9,50.1],[161.9,50.7],[165.8,50.6],[167.5,50.2],[168.9,49.9]]},{"name":"KUJIRA","coordinates":[[158.7,16.6],[158.6,17.2],[158.9,17.9],[159.3,18.6],[159.5,19.3],[159.3,20.0],[158.7,20.7],[157.6,21.9],[156.3,23.3],[154.9,24.9],[153.6,26.4],[153.1,27.7],[152.9,28.7],[153.1,30.5],[153.8,32.6],[154.9,34.7],[156.4,36.6],[158.4,38.6],[160.7,40.0],[163.0,41.0],[166.2,41.2],[169.2,41.1],[172.1,40.4],[175.4,39.6],[177.8,38.4],[180.4,37.1]]},{"name":"CHAN-HOM","coordinates":[[140.0,21.4],[140.0,21.8],[139.7,22.1],[139.3,22.2],[139.2,22.2],[139.1,22.4],[139.3,22.9],[139.1,23.3],[138.6,23.7],[138.1,24.1],[137.6,24.3],[136.9,24.7],[135.8,25.2],[134.7,25.7],[133.7,26.5],[133.3,26.8],[133.0,27.3],[132.8,27.6],[132.8,27.9],[132.9,28.2],[133.0,28.7],[133.1,29.1],[133.3,29.4],[133.4,29.8],[133.4,30.0],[133.4,30.1],[133.3,30.2],[133.3,30.4],[133.4,30.5],[133.7,30.7],[134.0,31.0],[134.4,31.2],[134.8,31.4],[135.4,31.8],[135.7,32.0],[136.0,32.1],[136.8,32.3],[137.7,32.2],[138.2,32.2],[138.9,32.3],[139.5,32.2],[140.0,32.4],[140.6,32.1],[141.3,31.8],[142.0,31.4],[142.2,30.8],[142.3,30.3],[142.5,29.6],[142.7,29.1],[143.2,28.9],[144.1,28.6],[144.6,28.6],[144.8,28.6],[144.5,28.6],[144.4,28.5],[144.5,28.7],[144.2,28.8],[144.1,28.9],[144.0,29.4],[143.8,29.7],[144.1,30.0],[144.3,30.5],[145.5,31.1],[146.5,32.0],[147.4,33.1],[149.5,34.7],[152.9,36.4],[155.9,37.2],[159.0,38.1],[161.9,39.0],[164.4,39.0],[166.7,38.7],[168.9,38.5],[170.0,38.4],[171.3,38.2],[171.8,38.2]]},{"name":"LINFA","coordinates":[[125.9,13.8],[125.4,13.8],[124.8,13.8],[124.3,13.8],[123.9,13.7],[122.6,13.2],[121.2,12.9],[119.1,12.8],[118.0,12.7],[116.8,12.8],[115.7,13.2],[115.2,13.4],[114.7,13.5],[114.2,13.7],[113.1,14.3],[111.7,14.5],[110.2,14.6],[109.4,14.9],[108.5,15.2],[107.9,14.9],[107.3,14.6],[106.9,14.4],[106.7,14.2]]},{"name":"NANGKA","coordinates":[[119.9,16.7],[119.4,16.8],[118.7,17.0],[118.0,17.2],[117.2,17.6],[116.0,17.6],[114.5,17.8],[113.4,17.9],[112.0,18.3],[111.2,18.6],[110.4,19.0],[108.6,19.8],[107.2,19.9],[106.6,19.9],[105.9,19.9]]},{"name":"SAUDEL","coordinates":[[130.3,13.1],[129.4,13.3],[128.1,13.9],[127.3,14.2],[126.0,15.0],[124.5,15.5],[123.0,15.7],[121.8,15.8],[119.8,16.1],[118.8,16.0],[117.8,16.2],[117.4,15.8],[116.5,16.0],[116.3,16.8],[115.8,16.9],[115.9,17.1],[115.7,17.5],[115.3,17.5],[114.7,17.7],[114.2,17.9],[113.6,18.1],[113.1,18.2],[112.2,17.8],[111.1,17.7],[109.7,17.5],[109.0,17.5],[108.2,17.5],[107.6,17.5]]},{"name":"MOLAVE","coordinates":[[137.5,9.4],[137.1,9.6],[136.5,9.8],[135.5,10.0],[134.8,10.0],[134.2,10.5],[133.6,11.1],[132.3,12.0],[131.1,12.6],[129.7,13.1],[128.8,13.3],[127.4,13.4],[126.4,13.4],[124.7,13.4],[123.2,13.3],[121.8,13.1],[120.4,13.2],[118.8,13.4],[117.5,13.4],[116.0,13.4],[114.4,13.4],[113.2,13.5],[112.1,13.8],[110.9,14.2],[109.8,14.6],[108.7,15.2],[108.4,15.4],[106.4,15.8],[105.0,15.0]]},{"name":"GONI","coordinates":[[141.7,14.1],[141.7,14.6],[141.6,15.1],[141.5,15.7],[141.1,16.0],[140.7,16.2],[140.0,16.4],[139.3,16.4],[138.6,16.5],[137.8,16.6],[136.7,16.6],[135.7,16.7],[134.5,16.7],[133.4,16.4],[132.7,16.4],[131.6,16.4],[130.9,16.1],[129.9,15.9],[128.8,15.3],[127.6,14.7],[126.5,14.2],[125.0,13.8],[123.6,13.5],[121.9,13.7],[121.3,14.3],[119.5,14.5],[118.4,14.8],[117.6,15.1],[116.8,15.1],[116.0,15.1],[115.4,15.0],[115.2,14.8],[114.7,14.8],[114.0,14.6],[113.6,14.4],[113.3,14.3],[112.8,14.3],[112.2,14.4],[111.7,14.5],[111.4,13.9],[110.9,13.8],[110.1,14.0],[109.4,14.1],[107.2,14.7]]},{"name":"ATSANI","coordinates":[[142.9,11.5],[141.9,12.5],[140.1,13.3],[138.8,13.9],[137.4,14.5],[136.0,14.9],[134.3,15.6],[132.5,16.0],[130.6,16.6],[129.1,17.9],[128.1,19.2],[127.0,19.6],[126.7,19.6],[127.1,19.8],[127.6,20.1],[127.9,20.0],[128.5,19.8],[128.8,19.7],[129.2,19.8],[129.0,20.3],[128.7,20.2],[127.7,20.0],[126.7,19.9],[125.5,20.1],[124.2,20.5],[123.0,20.6],[121.9,21.1],[120.9,21.3],[120.2,21.7],[119.7,22.3],[119.5,22.6],[119.2,22.7]]},{"name":"ETAU","coordinates":[[130.7,10.0],[129.3,10.7],[127.8,11.3],[125.9,12.2],[123.7,13.0],[122.6,13.0],[121.5,12.8],[120.0,12.7],[118.2,12.7],[115.4,12.9],[113.0,12.8],[112.0,12.5],[111.4,12.2],[110.8,12.2],[110.3,12.5],[108.7,12.5],[107.4,12.6],[106.4,12.4]]},{"name":"VAMCO","coordinates":[[135.2,8.2],[133.9,8.8],[133.2,9.4],[132.6,10.0],[131.6,10.9],[130.9,11.5],[130.4,11.9],[130.0,12.3],[128.9,13.4],[128.1,14.3],[126.6,14.5],[125.7,14.5],[124.6,14.6],[123.5,14.4],[122.8,14.8],[121.3,15.1],[119.6,15.2],[118.5,15.2],[117.3,15.1],[116.3,15.2],[115.5,15.4],[114.4,15.4],[113.4,15.5],[112.4,15.6],[111.4,15.8],[110.3,15.9],[109.4,16.4],[108.6,16.7],[107.9,17.1],[106.6,17.9],[105.9,18.1],[104.3,18.7],[103.6,19.2],[103.0,20.1]]},{"name":"KROVANH","coordinates":[[127.2,7.2],[126.1,8.2],[124.2,9.4],[122.3,8.6],[120.9,8.6],[119.3,9.2],[117.7,9.9],[116.1,9.2],[115.7,9.6],[115.2,10.0],[114.5,9.8],[114.1,9.4],[113.5,9.0],[112.8,8.8],[112.1,8.6],[111.4,8.1],[111.1,7.3],[110.6,7.7],[110.2,8.1],[109.4,8.0],[109.1,8.1],[107.8,8.6],[106.2,8.0],[105.2,7.7],[103.9,7.5],[102.8,7.6],[101.7,8.2],[100.6,9.0],[99.6,9.9]]}];

      const sourceLayer = new ol.layer.Vector({
        source: new ol.source.Vector({
            features: new ol.format.GeoJSON().readFeatures(
              {
                type: "FeatureCollection",
                features: typhoon.map(item=>{
                  return {
                      type: "Feature",
                      geometry: {
                        type: "LineString",
                        coordinates: item.coordinates,
                      },
                      properties: {},
                  }
                }),
              },
              {
                dataProjection: "EPSG:4326",
                featureProjection: "EPSG:3857",
              }
            ),
            attributions: [
              "気象庁「<a href='http://www.data.jma.go.jp/fcd/yoho/typhoon/position_table/table2020.html'>台風位置表　令和2年（2020年）</a>」を加工して作成"
            ]
        }),
        style: new ol.style.Style({
          stroke: new ol.style.Stroke({
            color: 'green',
            width: 2,
          }),
        }),
      });
      new ol.Map({
        target: 'default',
        layers: [
          new ol.layer.Tile({
            source: new ol.source.OSM()
          }),
          sourceLayer
        ],
        view: new ol.View({
          center: ol.proj.fromLonLat([135, 30]),
          zoom: 3
        }),
      });

      const prng = tcjs.utils.random("test.");
      const randomColors = (num)=>{
          const diff = 360 / num;
          const colors =[];
          const base = Math.floor(prng() * 360);
          for (let i = 0; i < num; i++) {
            const color = (base + i * diff) % 360;
            colors.push("hsl(" + color + ", 100%, 50%)");
          }

          return colors;
      }
      const testdata = typhoon.map((item)=>{
        return item.coordinates
      })

      const kmedoids = new tcjs.kmedoids.Kmedoids(testdata);
      const maxK = Math.floor(testdata.length/2);
      const cvi = "silhouette";
      tcjs.kmedoids.optimize(kmedoids, {
          prng,
          cvi,
          maxCluster: maxK
      }).then((result)=>{
          const scoreGraph = document.createElement("canvas");
          const scores = [null].concat(result.scores.map(({k, score})=>{
            return score
          }))
          console.log(result)
          new Chart(scoreGraph.getContext('2d'), {
            type: 'line',
            data: {
              labels: tcjs.utils.range(1, maxK + 1),
              datasets: [{
                data: scores,
                spanGaps: true,
                label: "score: " + cvi
              }]
            }
          });
          document.getElementById("score_graph").appendChild(scoreGraph);

          const layers = [new ol.layer.Tile({
            source: new ol.source.OSM()
          })];

          const colors = randomColors(result.k);
          result.clusters.forEach((clasterIndexes,i)=>{
              const sourceLayer = new ol.layer.Vector({
                  source: new ol.source.Vector({
                      features: new ol.format.GeoJSON().readFeatures(
                        {
                          type: "FeatureCollection",
                          features: clasterIndexes.map(i=>{
                            return {
                                type: "Feature",
                                geometry: {
                                  type: "LineString",
                                  coordinates: testdata[i],
                                },
                                properties: {
                                  medoid: result.medoids.includes(i)
                                },
                            }
                          }),
                        },
                        {
                          dataProjection: "EPSG:4326",
                          featureProjection: "EPSG:3857",
                        }
                      ),
                      attributions: [
                        "気象庁「<a href='http://www.data.jma.go.jp/fcd/yoho/typhoon/position_table/table2020.html'>台風位置表　令和2年（2020年）</a>」を加工して作成"
                      ]
                  }),
                  style : (feature)=>{
                    return new ol.style.Style({
                      stroke: new ol.style.Stroke({
                        color: colors[i],
                        width: feature.getProperties()["medoid"]? 5:2,
                      }),
                    })
                  },
              });
              layers.push(sourceLayer);
          })

          new ol.Map({
            target: 'result',
            layers,
            view: new ol.View({
              center: ol.proj.fromLonLat([135, 30]),
              zoom: 3
            }),
          });
        });
    </script>
</body>
</html>
